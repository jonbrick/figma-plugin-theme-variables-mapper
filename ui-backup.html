<!-- 
  REMINDER: This plugin must use ES5 syntax as Figma does not support ES6.
  Avoid using:
  - Arrow functions
  - const/let
  - Template literals
  - Spread operators
  - Destructuring
  - Classes
  - Modules
  - Promises
  - Async/await
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Collection Variable Mapper</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --primary: 222.2 47.4% 11.2%;
        --primary-foreground: 210 40% 98%;
        --secondary: 210 40% 96%;
        --muted: 210 40% 96%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --border: 214.3 31.8% 91.4%;
        --destructive: 0 84.2% 60.2%;
        --success: 142.1 76.2% 36.3%;
        --warning: 47.9 95.8% 53.1%;
        --radius: 8px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 13px;
        line-height: 1.5;
        color: hsl(var(--foreground));
        background-color: hsl(var(--background));
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 24px;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .subtitle {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
      }

      .section {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
      }

      .section h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: hsl(var(--foreground));
      }

      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
        padding: 0 20px;
        height: 44px;
        width: 100%;
      }

      .btn:disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
      }

      .btn-primary:hover:not(:disabled) {
        background: hsl(var(--primary) / 0.9);
      }

      .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--foreground));
        border: 1px solid hsl(var(--border));
      }

      .loading {
        text-align: center;
        padding: 40px 20px;
      }

      .loader {
        width: 24px;
        height: 24px;
        border: 3px solid hsl(var(--muted));
        border-top: 3px solid hsl(var(--primary));
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results {
        margin-top: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .summary-card {
        background: hsl(var(--muted) / 0.3);
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 16px;
        text-align: center;
      }

      .summary-card.highlight {
        background: hsl(var(--success) / 0.1);
        border-color: hsl(var(--success) / 0.3);
      }

      .stat-number {
        font-size: 24px;
        font-weight: 800;
        color: hsl(var(--primary));
        display: block;
      }

      .stat-label {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        font-weight: 500;
      }

      .results-text {
        background: hsl(var(--muted) / 0.3);
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 16px;
        font-family: "SF Mono", "Monaco", "Cascadia Code", monospace;
        font-size: 11px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 12px;
      }

      .copy-btn {
        width: auto;
        padding: 0 16px;
        height: 36px;
        font-size: 12px;
        margin-right: 8px;
      }

      .download-btn {
        width: auto;
        padding: 0 16px;
        height: 36px;
        font-size: 12px;
      }

      .error {
        background: hsl(var(--destructive) / 0.1);
        border: 1px solid hsl(var(--destructive) / 0.3);
        border-radius: var(--radius);
        padding: 16px;
        color: hsl(var(--destructive));
      }

      .warning {
        background: hsl(var(--warning) / 0.1);
        border: 1px solid hsl(var(--warning) / 0.3);
        border-radius: var(--radius);
        padding: 12px;
        color: hsl(var(--warning));
        font-size: 12px;
        margin-bottom: 16px;
      }

      .hidden {
        display: none !important;
      }

      .collection-info {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        margin-top: 4px;
      }

      .button-group {
        display: flex;
        gap: 8px;
      }

      /* Add styles for optgroup */
      optgroup {
        font-weight: 600;
        color: hsl(var(--primary));
      }

      optgroup option {
        font-weight: normal;
        color: hsl(var(--foreground));
        padding-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üîÑ Collection Variable Mapper</h1>
      <p class="subtitle">
        Create variable aliases from source to target collection using CSS
        mappings
      </p>
    </div>

    <div id="setup-section">
      <div class="section">
        <h3>üìö Source Collection</h3>

        <div id="library-warning" class="warning hidden">
          ‚ö†Ô∏è Some library collections may not have loaded properly. Check the
          console for details.
        </div>

        <div class="form-group">
          <label for="source-collection-select"
            >Source Collection (variables to reference from):</label
          >
          <select id="source-collection-select">
            <option value="">Loading collections...</option>
          </select>
          <div id="source-collection-info" class="collection-info"></div>
        </div>
      </div>

      <div class="section">
        <h3>üéØ Target Collection</h3>

        <div class="form-group">
          <label for="target-collection-select"
            >Target Collection (where aliases will be created):</label
          >
          <select id="target-collection-select">
            <option value="">Select source collection first...</option>
          </select>
          <div id="target-collection-info" class="collection-info"></div>
        </div>

        <button id="next-btn" class="btn btn-primary" disabled>
          üìÑ Next: Upload CSS File
        </button>
      </div>
    </div>

    <div id="css-upload-section" class="hidden">
      <div class="section">
        <h3>üìÑ CSS Theme File</h3>

        <div class="form-group">
          <label for="css-file-input"
            >Upload CSS file with @theme inline block:</label
          >
          <input
            type="file"
            id="css-file-input"
            accept=".css"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid hsl(var(--border));
              border-radius: var(--radius);
              background: hsl(var(--background));
              color: hsl(var(--foreground));
              font-size: 13px;
              cursor: pointer;
            "
          />
          <div id="css-file-info" class="collection-info"></div>
        </div>

        <div id="css-preview" class="hidden" style="margin-bottom: 16px">
          <h4>üìã Preview of Variables to Create:</h4>
          <div
            id="css-preview-text"
            class="results-text"
            style="max-height: 200px"
          >
            Preview will appear here...
          </div>
        </div>

        <div class="button-group">
          <button
            id="back-btn"
            class="btn btn-secondary"
            style="width: auto; margin-right: 8px"
          >
            ‚Üê Back to Collections
          </button>
          <button
            id="create-variables-btn"
            class="btn btn-primary"
            disabled
            style="flex: 1"
          >
            üî® Create Variable Aliases
          </button>
        </div>
      </div>
    </div>

    <div id="loading-section" class="hidden">
      <div class="loading">
        <div class="loader"></div>
        <p>Creating variable aliases...</p>
        <p
          style="
            font-size: 11px;
            color: hsl(var(--muted-foreground));
            margin-top: 8px;
          "
        >
          This may take a moment for large collections...
        </p>
      </div>
    </div>

    <div id="results-section" class="hidden">
      <div class="section">
        <h3>üìä Mapping Results</h3>

        <div class="summary-grid">
          <div class="summary-card highlight">
            <span class="stat-number" id="total-variables-count">0</span>
            <span class="stat-label">Total Variables</span>
          </div>
          <div class="summary-card">
            <span class="stat-number" id="collection-type">-</span>
            <span class="stat-label">Collection Type</span>
          </div>
        </div>

        <div class="results">
          <h4>üìã Variable Mapping Results:</h4>
          <div id="results-text" class="results-text">
            Mapping results will appear here...
          </div>
          <div class="button-group">
            <button id="copy-btn" class="btn btn-secondary copy-btn">
              üìã Copy to Clipboard
            </button>
            <button id="download-btn" class="btn btn-secondary download-btn">
              üíæ Download JSON
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <button id="new-mapping-btn" class="btn btn-secondary">
          üîÑ New Mapping
        </button>
      </div>
    </div>

    <div id="error-section" class="hidden">
      <div class="error">
        <h3>‚ö†Ô∏è Error</h3>
        <p id="error-message">Something went wrong.</p>
        <button
          id="retry-btn"
          class="btn btn-secondary"
          style="margin-top: 12px"
        >
          üîÑ Try Again
        </button>
      </div>
    </div>

    <script>
      var collections = { libraries: [], locals: [] };
      var currentMapping = null;
      var hasLibraryError = false;
      var selectedCollections = {
        source: null,
        target: null,
      };
      var cssContent = null;

      var elements = {
        sourceCollectionSelect: document.getElementById(
          "source-collection-select"
        ),
        targetCollectionSelect: document.getElementById(
          "target-collection-select"
        ),
        sourceCollectionInfo: document.getElementById("source-collection-info"),
        targetCollectionInfo: document.getElementById("target-collection-info"),
        nextBtn: document.getElementById("next-btn"),
        backBtn: document.getElementById("back-btn"),
        cssFileInput: document.getElementById("css-file-input"),
        cssFileInfo: document.getElementById("css-file-info"),
        cssPreview: document.getElementById("css-preview"),
        cssPreviewText: document.getElementById("css-preview-text"),
        createVariablesBtn: document.getElementById("create-variables-btn"),
        copyBtn: document.getElementById("copy-btn"),
        downloadBtn: document.getElementById("download-btn"),
        newMappingBtn: document.getElementById("new-mapping-btn"),
        retryBtn: document.getElementById("retry-btn"),
        resultsText: document.getElementById("results-text"),
        libraryWarning: document.getElementById("library-warning"),
      };

      function handleCollectionsLoaded(data) {
        collections = {
          libraries: data.libraries || [],
          locals: data.locals || [],
        };

        // Show warning if there were library errors
        if (data.libraryError) {
          console.warn("Library loading error:", data.libraryError);
          hasLibraryError = true;
          elements.libraryWarning.classList.remove("hidden");
        }

        populateSourceSelect();
      }

      function populateSourceSelect() {
        var allCollections = [];

        // Add local collections
        for (var i = 0; i < collections.locals.length; i++) {
          allCollections.push({
            id: collections.locals[i].id,
            name: collections.locals[i].name,
            type: "local",
            parentName: "Local File",
            variableCount: collections.locals[i].variableCount || 0,
            modeCount: collections.locals[i].modeCount || 0,
          });
        }

        // Add library collections
        for (var i = 0; i < collections.libraries.length; i++) {
          var lib = collections.libraries[i];
          if (lib && lib.id) {
            allCollections.push({
              id: lib.id,
              name: lib.name,
              type: "library",
              parentName: lib.libraryName || "Unknown Library",
              variableCount: lib.variableCount || 0,
              error: lib.error,
            });
          }
        }

        console.log("All collections to display:", allCollections);

        // Sort collections by parent name, then collection name
        allCollections.sort(function (a, b) {
          if (a.parentName === b.parentName) {
            return a.name.localeCompare(b.name);
          }
          return a.parentName.localeCompare(b.parentName);
        });

        // Populate source collection select
        populateSelectElement(elements.sourceCollectionSelect, allCollections);
        validateSelection();
      }

      function populateTargetSelect() {
        // Only show local collections for target (can't create variables in libraries)
        var localCollections = [];

        for (var i = 0; i < collections.locals.length; i++) {
          localCollections.push({
            id: collections.locals[i].id,
            name: collections.locals[i].name,
            type: "local",
            parentName: "Local File",
            variableCount: collections.locals[i].variableCount || 0,
            modeCount: collections.locals[i].modeCount || 0,
          });
        }

        // Sort by name
        localCollections.sort(function (a, b) {
          return a.name.localeCompare(b.name);
        });

        // Clear and populate target select
        elements.targetCollectionSelect.innerHTML = "";

        if (localCollections.length === 0) {
          var option = document.createElement("option");
          option.value = "";
          option.textContent = "No local collections found";
          option.disabled = true;
          elements.targetCollectionSelect.appendChild(option);
          return;
        }

        // Add default option
        var defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Select target collection...";
        elements.targetCollectionSelect.appendChild(defaultOption);

        // Add optgroup for local collections
        var optgroup = document.createElement("optgroup");
        optgroup.label = "Local File Collections";
        elements.targetCollectionSelect.appendChild(optgroup);

        for (var i = 0; i < localCollections.length; i++) {
          var collection = localCollections[i];
          var option = document.createElement("option");
          option.value = collection.id;
          option.textContent =
            collection.name + " (" + collection.variableCount + " variables)";
          optgroup.appendChild(option);
        }

        validateSelection();
      }

      function populateSelectElement(selectElement, allCollections) {
        selectElement.innerHTML = "";

        if (allCollections.length === 0) {
          var option = document.createElement("option");
          option.value = "";
          option.textContent = "No collections found";
          option.disabled = true;
          selectElement.appendChild(option);
          return;
        }

        // Add default option
        var defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Select a collection...";
        selectElement.appendChild(defaultOption);

        var currentParent = null;
        for (var i = 0; i < allCollections.length; i++) {
          var collection = allCollections[i];

          // Add optgroup for new parent
          if (currentParent !== collection.parentName) {
            currentParent = collection.parentName;
            var optgroup = document.createElement("optgroup");
            optgroup.label = collection.parentName;
            selectElement.appendChild(optgroup);
          }

          var option = document.createElement("option");
          option.value = collection.id;

          var displayText =
            collection.name + " (" + collection.variableCount + " variables)";
          if (collection.error) {
            displayText += " ‚ö†Ô∏è Error";
          }
          option.textContent = displayText;

          if (collection.error) {
            option.style.color = "hsl(var(--destructive))";
            option.title = "Error: " + collection.error;
          }

          selectElement.lastChild.appendChild(option);
        }
      }

      function findCollection(id) {
        for (var i = 0; i < collections.locals.length; i++) {
          if (collections.locals[i].id === id) {
            return collections.locals[i];
          }
        }
        for (var i = 0; i < collections.libraries.length; i++) {
          if (collections.libraries[i].id === id) {
            return collections.libraries[i];
          }
        }
        return null;
      }

      function validateSelection() {
        var hasSourceCollection = elements.sourceCollectionSelect.value;
        var hasTargetCollection = elements.targetCollectionSelect.value;

        // Enable Next button only when both collections are selected
        elements.nextBtn.disabled =
          !hasSourceCollection || !hasTargetCollection;

        // Update info displays
        updateCollectionInfo(
          elements.sourceCollectionSelect.value,
          elements.sourceCollectionInfo
        );
        updateCollectionInfo(
          elements.targetCollectionSelect.value,
          elements.targetCollectionInfo
        );
      }

      function updateCollectionInfo(collectionId, infoElement) {
        if (!collectionId) {
          infoElement.textContent = "";
          return;
        }

        var collection = findCollection(collectionId);
        if (collection) {
          var info =
            collection.type === "local"
              ? "Local collection with " +
                (collection.modeCount || 1) +
                " mode(s)"
              : "Library collection from " +
                (collection.libraryName || "Unknown Library");

          if (collection.error) {
            info += " ‚ö†Ô∏è " + collection.error;
            infoElement.style.color = "hsl(var(--destructive))";
          } else {
            infoElement.style.color = "hsl(var(--muted-foreground))";
          }

          infoElement.textContent = info;
        }
      }

      function handleNext() {
        var sourceCollectionId = elements.sourceCollectionSelect.value;
        var targetCollectionId = elements.targetCollectionSelect.value;

        if (!sourceCollectionId || !targetCollectionId) return;

        console.log("üéØ Collections selected:");
        console.log("Source:", sourceCollectionId);
        console.log("Target:", targetCollectionId);

        // Store selected collections
        selectedCollections.source = sourceCollectionId;
        selectedCollections.target = targetCollectionId;

        // Navigate to CSS upload section
        showSection("css-upload-section");
      }

      function handleBack() {
        // Clear any uploaded CSS data
        cssContent = null;
        elements.cssFileInput.value = "";
        elements.cssFileInfo.textContent = "";
        elements.cssPreview.classList.add("hidden");
        elements.createVariablesBtn.disabled = true;

        // Go back to collection selection
        showSection("setup-section");
      }

      function handleCSSFileUpload(event) {
        var file = event.target.files[0];
        if (!file) {
          elements.cssFileInfo.textContent = "";
          elements.cssPreview.classList.add("hidden");
          elements.createVariablesBtn.disabled = true;
          cssContent = null;
          return;
        }

        console.log(
          "üìÑ CSS file selected:",
          file.name,
          "(" + file.size + " bytes)"
        );

        // Validate file type
        if (!file.name.toLowerCase().endsWith(".css")) {
          elements.cssFileInfo.textContent = "‚ö†Ô∏è Please select a .css file";
          elements.cssFileInfo.style.color = "hsl(var(--destructive))";
          elements.cssPreview.classList.add("hidden");
          elements.createVariablesBtn.disabled = true;
          cssContent = null;
          return;
        }

        // Show file info
        elements.cssFileInfo.textContent =
          "üìÑ " + file.name + " (" + Math.round(file.size / 1024) + " KB)";
        elements.cssFileInfo.style.color = "hsl(var(--muted-foreground))";

        // Read file content
        var reader = new FileReader();
        reader.onload = function (e) {
          cssContent = e.target.result;
          console.log("üìù CSS content loaded, length:", cssContent.length);

          // Preview the CSS mappings
          previewCSSMappings(cssContent);
        };
        reader.onerror = function () {
          elements.cssFileInfo.textContent = "‚ùå Error reading file";
          elements.cssFileInfo.style.color = "hsl(var(--destructive))";
          elements.cssPreview.classList.add("hidden");
          elements.createVariablesBtn.disabled = true;
          cssContent = null;
        };
        reader.readAsText(file);
      }

      function previewCSSMappings(cssContent) {
        try {
          // Strict validation - same as backend
          if (!cssContent.includes("@theme inline")) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è No @theme inline block found in CSS file";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }
          if (
            !cssContent.includes(":root,") &&
            !cssContent.includes(".light")
          ) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è No :root or .light block found in CSS file";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }
          if (!cssContent.includes(".dark")) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è No .dark block found in CSS file";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }

          // Parse @theme block
          var themeMatch = cssContent.match(/@theme\s+inline\s*\{([^}]+)\}/);
          if (!themeMatch) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è Could not parse @theme inline block";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }

          // Parse light mode block
          var lightMatch = cssContent.match(
            /(?::root\s*,\s*\.light|\.light)\s*\{([^}]+)\}/
          );
          if (!lightMatch) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è Could not parse light mode block";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }

          // Parse dark mode block
          var darkMatch = cssContent.match(/\.dark\s*\{([^}]+)\}/);
          if (!darkMatch) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è Could not parse dark mode block";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }

          // Parse theme mappings
          var themeContent = themeMatch[1];
          var themeVariables = {};
          var themeDeclarations = themeContent.split(";");

          for (var i = 0; i < themeDeclarations.length; i++) {
            var decl = themeDeclarations[i].trim();
            if (decl) {
              var colonIndex = decl.indexOf(":");
              if (colonIndex > 0) {
                var property = decl.substring(0, colonIndex).trim();
                var value = decl.substring(colonIndex + 1).trim();

                if (property.indexOf("--") === 0) {
                  property = property.substring(2);
                }
                var targetName = property.replace(/-/g, "/");

                // Parse intermediate reference (keep CSS format)
                var varMatch = value.match(/var\s*\(\s*(-[-\w]+)\s*\)/);
                if (varMatch) {
                  themeVariables[targetName] = varMatch[1]; // "--fill-danger"
                }
              }
            }
          }

          // Parse light mode values
          var lightContent = lightMatch[1];
          var lightValues = {};
          var lightDeclarations = lightContent.split(";");

          for (var i = 0; i < lightDeclarations.length; i++) {
            var decl = lightDeclarations[i].trim();
            if (decl) {
              var colonIndex = decl.indexOf(":");
              if (colonIndex > 0) {
                var property = decl.substring(0, colonIndex).trim();
                var value = decl.substring(colonIndex + 1).trim();
                if (property.indexOf("--") === 0) {
                  lightValues[property] = value;
                }
              }
            }
          }

          // Parse dark mode values
          var darkContent = darkMatch[1];
          var darkValues = {};
          var darkDeclarations = darkContent.split(";");

          for (var i = 0; i < darkDeclarations.length; i++) {
            var decl = darkDeclarations[i].trim();
            if (decl) {
              var colonIndex = decl.indexOf(":");
              if (colonIndex > 0) {
                var property = decl.substring(0, colonIndex).trim();
                var value = decl.substring(colonIndex + 1).trim();
                if (property.indexOf("--") === 0) {
                  darkValues[property] = value;
                }
              }
            }
          }

          console.log(
            "üìã Preview mappings found:",
            Object.keys(themeVariables).length
          );

          // Helper function to translate CSS values to Figma names (same logic as backend)
          function translateCSSToFigma(cssValue) {
            // Check for --alpha syntax first
            var alphaMatch = cssValue.match(
              /--alpha\s*\(\s*var\s*\(\s*--([\w-]+)\s*\)\s*\/\s*(\d+)%\s*\)/
            );
            if (alphaMatch) {
              var baseVariable = alphaMatch[1].replace(/-/g, "/");
              var opacity = parseInt(alphaMatch[2], 10);

              // Special case: 100% opacity - drop opacity completely
              if (opacity === 100) {
                return baseVariable;
              }

              // Handle special cases: black and white (no steps)
              if (baseVariable === "color/black") {
                return (
                  "color/black_" + (opacity < 10 ? "0" + opacity : opacity)
                );
              }
              if (baseVariable === "color/white") {
                return (
                  "color/white_" + (opacity < 10 ? "0" + opacity : opacity)
                );
              }

              // Regular color variables
              return (
                baseVariable + "_" + (opacity < 10 ? "0" + opacity : opacity)
              );
            }

            // Regular var() reference
            var varMatch = cssValue.match(/var\s*\(\s*--([\w-]+)\s*\)/);
            if (varMatch) {
              return varMatch[1].replace(/-/g, "/");
            }

            return cssValue; // Return as-is if can't parse
          }

          // Create preview showing translated Figma variable names
          var previewText =
            "Found " +
            Object.keys(themeVariables).length +
            " variable mappings:\n\n";
          var validMappings = 0;

          for (var targetName in themeVariables) {
            var intermediate = themeVariables[targetName]; // "--fill-danger"
            var lightSource = lightValues[intermediate];
            var darkSource = darkValues[intermediate];

            if (lightSource && darkSource) {
              // Translate CSS values to Figma variable names
              var lightFigmaName = translateCSSToFigma(lightSource);
              var darkFigmaName = translateCSSToFigma(darkSource);

              previewText += "‚Ä¢ " + targetName + "\n";
              previewText += "  Light: " + lightFigmaName + "\n";
              previewText += "  Dark: " + darkFigmaName + "\n\n";
              validMappings++;
            } else {
              previewText += "‚Ä¢ " + targetName + " ‚ùå Missing mode values\n\n";
            }
          }

          if (validMappings === 0) {
            elements.cssFileInfo.textContent =
              "‚ö†Ô∏è No valid variable mappings found - missing mode values";
            elements.cssFileInfo.style.color = "hsl(var(--warning))";
            elements.cssPreview.classList.add("hidden");
            elements.createVariablesBtn.disabled = true;
            return;
          }

          elements.cssPreviewText.textContent = previewText;
          elements.cssPreview.classList.remove("hidden");
          elements.createVariablesBtn.disabled = false;
        } catch (error) {
          console.error("‚ùå Error previewing CSS:", error);
          elements.cssFileInfo.textContent = "‚ö†Ô∏è Error parsing CSS file";
          elements.cssFileInfo.style.color = "hsl(var(--destructive))";
          elements.cssPreview.classList.add("hidden");
          elements.createVariablesBtn.disabled = true;
        }
      }

      function handleCreateVariables() {
        if (
          !cssContent ||
          !selectedCollections.source ||
          !selectedCollections.target
        ) {
          console.error("‚ùå Missing required data for variable creation");
          return;
        }

        console.log("üî® Starting variable creation process...");
        showSection("loading-section");

        // Send CSS content and collection IDs to plugin
        parent.postMessage(
          {
            pluginMessage: {
              type: "process-css-mapping",
              cssContent: cssContent,
              sourceCollectionId: selectedCollections.source,
              targetCollectionId: selectedCollections.target,
            },
          },
          "*"
        );
      }

      function displayMapping(mapping) {
        currentMapping = mapping;

        // Update summary cards
        var totalCreated = (mapping.data.created || []).length;
        var totalOverwritten = (mapping.data.overwritten || []).length;
        var totalFailed = (mapping.data.failed || []).length;
        var totalProcessed = totalCreated + totalOverwritten + totalFailed;

        document.getElementById("total-variables-count").textContent =
          totalProcessed;
        document.getElementById("collection-type").textContent =
          totalCreated + " Created, " + totalFailed + " Failed";

        // Create results summary
        var resultsText = "üìä Variable Mapping Results:\n\n";

        if (totalCreated > 0) {
          resultsText += "‚úÖ Created (" + totalCreated + "):\n";
          for (var i = 0; i < mapping.data.created.length; i++) {
            var item = mapping.data.created[i];
            resultsText +=
              "  ‚Ä¢ " + item.targetName + " ‚Üê " + item.sourceName + "\n";
          }
          resultsText += "\n";
        }

        if (totalOverwritten > 0) {
          resultsText += "üîÑ Overwritten (" + totalOverwritten + "):\n";
          for (var i = 0; i < mapping.data.overwritten.length; i++) {
            var item = mapping.data.overwritten[i];
            resultsText +=
              "  ‚Ä¢ " + item.targetName + " ‚Üê " + item.sourceName + "\n";
          }
          resultsText += "\n";
        }

        if (totalFailed > 0) {
          resultsText += "‚ùå Failed (" + totalFailed + "):\n";
          for (var i = 0; i < mapping.data.failed.length; i++) {
            var item = mapping.data.failed[i];
            resultsText += "  ‚Ä¢ " + item.targetName + " ‚Üê " + item.sourceName;
            if (item.error) {
              resultsText += " (" + item.error + ")";
            }
            resultsText += "\n";
          }
        }

        elements.resultsText.textContent = resultsText;
        showSection("results-section");
      }

      function showSection(sectionId) {
        var sections = [
          "setup-section",
          "css-upload-section",
          "loading-section",
          "results-section",
          "error-section",
        ];

        for (var i = 0; i < sections.length; i++) {
          var section = document.getElementById(sections[i]);
          section.classList.add("hidden");
        }

        var targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.remove("hidden");
        }
      }

      function showError(message) {
        document.getElementById("error-message").textContent = message;
        showSection("error-section");
      }

      function downloadJSON() {
        if (!currentMapping) return;

        var jsonData = JSON.stringify(currentMapping.data, null, 2);
        var blob = new Blob([jsonData], { type: "application/json" });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download =
          currentMapping.collection.name.replace(/[^a-zA-Z0-9-_]/g, "-") +
          "-variables.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Update button text temporarily
        var originalText = elements.downloadBtn.textContent;
        elements.downloadBtn.textContent = "‚úì Downloaded!";
        setTimeout(function () {
          elements.downloadBtn.textContent = originalText;
        }, 2000);
      }

      // Handle messages from the plugin
      window.onmessage = function (event) {
        var message = event.data.pluginMessage;
        if (!message) return;

        switch (message.type) {
          case "collections-loaded":
            if (message.success) {
              handleCollectionsLoaded(message);
            } else {
              showError(message.message || "Failed to load collections");
            }
            break;
          case "mapping-complete":
            if (message.success) {
              displayMapping(message);
            } else {
              showError(message.message || "Mapping failed");
            }
            break;
          case "error":
            showError(message.message || "Unknown error occurred");
            break;
          default:
            console.warn("Unknown message type:", message.type);
        }
      };

      // Initialize UI
      document.addEventListener("DOMContentLoaded", function () {
        console.log("UI initialized, requesting collections...");

        // Load collections
        parent.postMessage({ pluginMessage: { type: "get-collections" } }, "*");

        // Set up event listeners
        elements.sourceCollectionSelect.addEventListener("change", function () {
          // When source changes, populate target select
          if (elements.sourceCollectionSelect.value) {
            populateTargetSelect();
          } else {
            // Clear target select if no source selected
            elements.targetCollectionSelect.innerHTML =
              '<option value="">Select source collection first...</option>';
          }
          validateSelection();
        });

        elements.targetCollectionSelect.addEventListener(
          "change",
          validateSelection
        );
        elements.nextBtn.addEventListener("click", handleNext);
        elements.backBtn.addEventListener("click", handleBack);
        elements.cssFileInput.addEventListener("change", handleCSSFileUpload);
        elements.createVariablesBtn.addEventListener(
          "click",
          handleCreateVariables
        );

        elements.newMappingBtn.addEventListener("click", function () {
          showSection("setup-section");
          currentMapping = null;
          hasLibraryError = false;
          elements.libraryWarning.classList.add("hidden");
        });

        elements.retryBtn.addEventListener("click", function () {
          showSection("setup-section");
          parent.postMessage(
            { pluginMessage: { type: "get-collections" } },
            "*"
          );
        });

        // Download button functionality
        elements.downloadBtn.addEventListener("click", downloadJSON);

        // Copy button functionality
        elements.copyBtn.addEventListener("click", function () {
          var text = elements.resultsText.textContent;

          // Try modern clipboard API first
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(text)
              .then(function () {
                var originalText = elements.copyBtn.textContent;
                elements.copyBtn.textContent = "‚úì Copied!";
                setTimeout(function () {
                  elements.copyBtn.textContent = originalText;
                }, 2000);
              })
              .catch(function (err) {
                console.error("Failed to copy text: ", err);
                fallbackCopyTextToClipboard(text);
              });
          } else {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(text);
          }
        });

        // Show setup section by default
        showSection("setup-section");
      });

      // Fallback copy function for older browsers
      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand("copy");
          if (successful) {
            var originalText = elements.copyBtn.textContent;
            elements.copyBtn.textContent = "‚úì Copied!";
            setTimeout(function () {
              elements.copyBtn.textContent = originalText;
            }, 2000);
          } else {
            console.error("Fallback copy failed");
          }
        } catch (err) {
          console.error("Fallback copy error: ", err);
        }

        document.body.removeChild(textArea);
      }
    </script>
  </body>
</html>
