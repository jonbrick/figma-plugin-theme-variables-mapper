<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Theme Variables Mapper</title>
    <style>
      /* Inline CSS - Required for Figma plugins */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --card-foreground: 222.2 84% 4.9%;
        --primary: 222.2 47.4% 11.2%;
        --primary-foreground: 210 40% 98%;
        --secondary: 210 40% 96%;
        --secondary-foreground: 222.2 47.4% 11.2%;
        --muted: 210 40% 96%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --accent: 210 40% 96%;
        --border: 214.3 31.8% 91.4%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 210 40% 98%;
        --radius: 8px;
        --success: 142.1 76.2% 36.3%;
        --warning: 47.9 95.8% 53.1%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 13px;
        line-height: 1.5;
        color: hsl(var(--foreground));
        background-color: hsl(var(--background));
        padding: 20px;
      }

      #app {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .section {
        opacity: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .hidden {
        display: none !important;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 16px 0;
        background: hsl(var(--background));
        border-radius: var(--radius);
        margin-bottom: 8px;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
        letter-spacing: -0.025em;
        line-height: 1.2;
      }

      .subtitle {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 500;
        max-width: 320px;
        margin: 0 auto;
        line-height: 1.4;
      }

      /* Upload area */
      .upload-area {
        border: 2px dashed hsl(var(--border));
        border-radius: calc(var(--radius) + 4px);
        padding: 48px 24px;
        text-align: center;
        background: hsl(var(--background));
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: hsl(var(--primary));
        background: hsl(var(--accent));
      }

      .upload-content .upload-icon {
        font-size: 56px;
        margin-bottom: 16px;
        opacity: 0.7;
      }

      .upload-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: hsl(var(--foreground));
        line-height: 1.3;
      }

      .upload-content p {
        color: hsl(var(--muted-foreground));
        margin-bottom: 24px;
        font-size: 14px;
        line-height: 1.4;
      }

      .supported-formats {
        text-align: center;
        margin-top: 16px;
      }

      .supported-formats small {
        color: hsl(var(--muted-foreground));
        font-size: 12px;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px 24px;
        background: hsl(var(--card));
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .loader {
        width: 28px;
        height: 28px;
        border: 3px solid hsl(var(--muted));
        border-top: 3px solid hsl(var(--primary));
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
      }

      /* Library Info */
      .library-info {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 16px;
        margin-bottom: 16px;
      }

      .library-info h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: hsl(var(--foreground));
      }

      .library-item {
        margin-bottom: 8px;
        padding: 8px;
        background: hsl(var(--muted) / 0.3);
        border-radius: calc(var(--radius) - 2px);
      }

      .library-name {
        font-weight: 600;
        font-size: 13px;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
      }

      .collection-item {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        margin-left: 12px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      }

      .library-selector {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
      }

      .library-selector h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: hsl(var(--foreground));
      }

      .library-selector select {
        width: 100%;
        padding: 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
        padding: 0 20px;
        height: 44px;
        gap: 8px;
      }

      .btn:disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border: 1px solid hsl(var(--primary));
      }

      .btn-primary:hover:not(:disabled) {
        background: hsl(var(--primary) / 0.9);
      }

      .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        border: 1px solid hsl(var(--border));
      }

      .btn-secondary:hover:not(:disabled) {
        background: hsl(var(--muted));
      }

      /* Cards */
      .summary-card,
      .result-group,
      .error-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .summary-card {
        padding: 24px;
        text-align: center;
      }

      .summary-card.success {
        border-color: hsl(var(--success) / 0.3);
        background: hsl(var(--success) / 0.05);
      }

      .summary-card.warning {
        border-color: hsl(var(--warning) / 0.3);
        background: hsl(var(--warning) / 0.05);
      }

      .summary-card.error {
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .stat-number {
        font-size: 32px;
        font-weight: 800;
        color: hsl(var(--primary));
        line-height: 1;
      }

      .summary-card.success .stat-number {
        color: hsl(var(--success));
      }

      .summary-card.warning .stat-number {
        color: hsl(var(--warning));
      }

      .summary-card.error .stat-number {
        color: hsl(var(--destructive));
      }

      .stat-label {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 600;
      }

      /* Result groups */
      .result-group {
        margin-bottom: 8px;
        overflow: visible;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
      }

      .result-title {
        padding: 12px 16px;
        background: hsl(var(--muted));
        border-bottom: 1px solid hsl(var(--border));
        font-size: 13px;
        font-weight: 600;
        margin: 0;
        color: hsl(var(--foreground));
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 40px;
      }

      .result-title::after {
        content: "▼";
        font-size: 10px;
        position: absolute;
        right: 16px;
        transition: transform 0.2s ease;
      }

      .result-group.collapsed .result-title::after {
        transform: rotate(-90deg);
      }

      .result-group.collapsed .variable-list {
        display: none;
      }

      .result-count {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        background: hsl(var(--background));
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
      }

      .variable-list {
        padding: 0;
        max-height: none;
        overflow-y: visible;
        transition: all 0.2s ease;
      }

      .variable-item {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        border-bottom: 1px solid hsl(var(--border));
      }

      .variable-item:last-child {
        border-bottom: none;
      }

      .variable-item:hover {
        background: hsl(var(--muted) / 0.3);
      }

      .variable-name {
        font-weight: 700;
        color: hsl(var(--foreground));
        font-size: 13px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        line-height: 1.3;
        word-break: break-all;
      }

      .variable-references {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: hsl(var(--muted) / 0.3);
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .reference-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 11px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        word-break: break-all;
      }

      .reference-label {
        color: hsl(var(--muted-foreground));
        font-weight: 500;
      }

      .reference-value {
        color: hsl(var(--foreground));
        font-weight: 600;
      }

      .error-text {
        color: hsl(var(--destructive));
        font-weight: 500;
        font-size: 11px;
        line-height: 1.4;
        word-break: break-word;
      }

      /* Actions */
      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid hsl(var(--border));
      }

      /* Error card */
      .error-card {
        padding: 32px 24px;
        text-align: center;
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .error-card h3 {
        color: hsl(var(--destructive));
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.3;
      }

      .error-card p {
        color: hsl(var(--destructive) / 0.8);
        margin-bottom: 24px;
        font-size: 14px;
        line-height: 1.4;
      }

      /* Form Elements */
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        transition: all 0.2s ease;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: hsl(var(--foreground));
        margin-bottom: 8px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      /* Collection Selection */
      .collection-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .collection-card h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: hsl(var(--foreground));
      }

      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .radio-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid transparent;
        transition: all 0.2s ease;
      }

      .radio-option:hover {
        background: hsl(var(--muted) / 0.5);
      }

      .radio-option.selected {
        background: hsl(var(--accent));
        border-color: hsl(var(--primary));
      }

      .radio-input {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid hsl(var(--border));
        border-radius: 50%;
        margin: 0;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .radio-input:checked {
        border-color: hsl(var(--primary));
      }

      .radio-input:checked::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 8px;
        height: 8px;
        background: hsl(var(--primary));
        border-radius: 50%;
      }

      .radio-content {
        flex: 1;
      }

      .radio-label {
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
        display: block;
      }

      .radio-description {
        font-size: 12px;
        color: hsl(var(--muted-foreground));
        line-height: 1.4;
      }

      .collection-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        margin-top: 8px;
      }

      .collection-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        margin-top: 8px;
      }

      .collection-input:focus,
      .collection-select:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .warning {
        background: hsl(var(--warning) / 0.1);
        border: 1px solid hsl(var(--warning) / 0.3);
        border-radius: var(--radius);
        padding: 12px;
        color: hsl(var(--warning));
        font-size: 12px;
        margin-bottom: 16px;
      }

      /* Responsive */
      @media (max-width: 480px) {
        body {
          padding: 16px;
        }

        .summary-grid {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Theme Variables Mapper</h1>
        <p class="subtitle">
          Map CSS @theme variables to Figma variables <br />
          with shared library references
        </p>
      </div>

      <div id="upload-section" class="section">
        <div class="library-info" id="library-info">
          <h3>📚 Available Libraries</h3>
          <div id="library-warning" class="warning hidden">
            ⚠️ Some library collections may not have loaded properly. Check the
            console for details.
          </div>
          <div id="library-list">Loading libraries...</div>
        </div>

        <div class="upload-area" id="upload-area">
          <div class="upload-content">
            <div class="upload-icon">📁</div>
            <h3>Upload CSS File</h3>
            <p>Drag & drop your CSS file with @theme variables</p>
            <input type="file" id="file-input" accept=".css" hidden />
            <button id="browse-btn" class="btn btn-primary">Choose File</button>
          </div>
        </div>
        <div class="supported-formats">
          <small>Supported: .css files with @theme and light/dark modes</small>
        </div>
      </div>

      <div id="loading-section" class="section hidden">
        <div class="loading">
          <div class="loader"></div>
          <p id="loading-text">Parsing CSS file...</p>
        </div>
      </div>

      <div id="preview-section" class="section hidden">
        <h2>📋 Configure & Preview</h2>

        <div class="library-selector">
          <h3>📚 Select Library Collection</h3>
          <select id="library-select">
            <option value="">Choose a library collection...</option>
          </select>
        </div>

        <div class="collection-card">
          <h3>📁 Select Variable Collection</h3>
          <div class="radio-group">
            <label class="radio-option" id="existing-option">
              <input
                type="radio"
                name="collection-type"
                value="existing"
                class="radio-input"
                id="existing-radio"
                checked
              />
              <div class="radio-content">
                <span class="radio-label">Use Existing Collection</span>
                <p class="radio-description">
                  Add variables to an existing collection
                </p>
                <select
                  class="collection-select"
                  id="existing-collection-select"
                >
                  <option value="">Choose an existing collection...</option>
                </select>
              </div>
            </label>

            <label class="radio-option" id="new-option">
              <input
                type="radio"
                name="collection-type"
                value="new"
                class="radio-input"
                id="new-radio"
              />
              <div class="radio-content">
                <span class="radio-label">Create New Collection</span>
                <p class="radio-description">
                  Create a new collection for these variables
                </p>
                <input
                  type="text"
                  class="collection-input"
                  id="new-collection-input"
                  placeholder="New Collection Name"
                  value="Theme Variables"
                  style="display: none"
                />
              </div>
            </label>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-stat">
            <span class="stat-number" id="preview-total">0</span>
            <span class="stat-label">theme variables found</span>
          </div>
        </div>

        <div id="preview-variables" class="result-group">
          <h3 class="result-title">
            🎨 Variables to Create
            <span class="result-count" id="preview-count">0</span>
          </h3>
          <div id="preview-variables-list" class="variable-list"></div>
        </div>

        <div class="actions">
          <button id="apply-btn" class="btn btn-primary" disabled>
            Apply Changes
          </button>
          <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>

      <div id="results-section" class="section hidden">
        <h2>🎉 Results</h2>

        <div class="summary-grid">
          <div class="summary-card success">
            <div class="summary-stat">
              <span class="stat-number" id="created-count">0</span>
              <span class="stat-label">Created</span>
            </div>
          </div>
          <div class="summary-card warning">
            <div class="summary-stat">
              <span class="stat-number" id="updated-count">0</span>
              <span class="stat-label">Updated</span>
            </div>
          </div>
          <div class="summary-card error">
            <div class="summary-stat">
              <span class="stat-number" id="failed-count">0</span>
              <span class="stat-label">Failed</span>
            </div>
          </div>
        </div>

        <div id="results-created" class="result-group">
          <h3 class="result-title">
            ✅ Created Variables
            <span class="result-count" id="created-result-count">0</span>
          </h3>
          <div id="results-created-list" class="variable-list"></div>
        </div>

        <div id="results-updated" class="result-group">
          <h3 class="result-title">
            ⚠️ Updated Variables
            <span class="result-count" id="updated-result-count">0</span>
          </h3>
          <div id="results-updated-list" class="variable-list"></div>
        </div>

        <div id="results-failed" class="result-group">
          <h3 class="result-title">
            ❌ Failed Variables
            <span class="result-count" id="failed-result-count">0</span>
          </h3>
          <div id="results-failed-list" class="variable-list"></div>
        </div>

        <div class="actions">
          <button id="upload-new-btn" class="btn btn-secondary">
            Upload New File
          </button>
          <button id="close-btn" class="btn btn-primary">Close</button>
        </div>
      </div>

      <div id="error-section" class="section hidden">
        <div class="error-card">
          <h3>⚠️ Error</h3>
          <p id="error-message">Something went wrong.</p>
          <button id="retry-btn" class="btn btn-primary">
            Upload New File
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("Plugin UI loaded");

      var isProcessing = false;
      var currentResults = null;
      var availableLibraries = [];
      var localCollections = [];

      var elements = {
        fileInput: document.getElementById("file-input"),
        browseBtn: document.getElementById("browse-btn"),
        uploadArea: document.getElementById("upload-area"),
        librarySelect: document.getElementById("library-select"),
        existingRadio: document.getElementById("existing-radio"),
        newRadio: document.getElementById("new-radio"),
        existingCollectionSelect: document.getElementById(
          "existing-collection-select"
        ),
        newCollectionInput: document.getElementById("new-collection-input"),
        uploadNewBtn: document.getElementById("upload-new-btn"),
        closeBtn: document.getElementById("close-btn"),
        retryBtn: document.getElementById("retry-btn"),
        cancelBtn: document.getElementById("cancel-btn"),
        applyBtn: document.getElementById("apply-btn"),
        loadingText: document.getElementById("loading-text"),
        errorMessage: document.getElementById("error-message"),
        previewTotal: document.getElementById("preview-total"),
        previewCount: document.getElementById("preview-count"),
        previewVariablesList: document.getElementById("preview-variables-list"),
        createdCount: document.getElementById("created-count"),
        updatedCount: document.getElementById("updated-count"),
        failedCount: document.getElementById("failed-count"),
        createdResultCount: document.getElementById("created-result-count"),
        updatedResultCount: document.getElementById("updated-result-count"),
        failedResultCount: document.getElementById("failed-result-count"),
        resultsCreatedList: document.getElementById("results-created-list"),
        resultsUpdatedList: document.getElementById("results-updated-list"),
        resultsFailedList: document.getElementById("results-failed-list"),
        libraryWarning: document.getElementById("library-warning"),
      };

      function handleFileSelect(event) {
        var file = event.target.files[0];
        if (file) {
          processFile(file);
        }
      }

      function handleCollectionTypeChange() {
        var existingOption = document.getElementById("existing-option");
        var newOption = document.getElementById("new-option");

        // Update visual selection
        if (elements.existingRadio.checked) {
          existingOption.classList.add("selected");
          newOption.classList.remove("selected");
          elements.existingCollectionSelect.style.display = "block";
          elements.newCollectionInput.style.display = "none";
        } else {
          newOption.classList.add("selected");
          existingOption.classList.remove("selected");
          elements.existingCollectionSelect.style.display = "none";
          elements.newCollectionInput.style.display = "block";
        }

        validateForm();
      }

      function validateForm() {
        var selectedLibrary = elements.librarySelect.value;
        var collectionChoice = elements.existingRadio.checked
          ? "existing"
          : "new";
        var existingCollectionId = elements.existingCollectionSelect.value;
        var newCollectionName = elements.newCollectionInput.value.trim();

        var isValid = selectedLibrary !== "";
        if (isValid) {
          if (collectionChoice === "existing") {
            isValid = existingCollectionId !== "";
          } else {
            isValid = newCollectionName !== "";
          }
        }

        elements.applyBtn.disabled = !isValid;
      }

      function handleMessage(event) {
        var message = event.data.pluginMessage;
        if (!message) return;

        console.log("Received message:", message.type);

        switch (message.type) {
          case "collections-loaded":
            if (message.success) {
              handleCollectionsLoaded(message);
            } else {
              displayError(message.message || "Failed to load collections");
            }
            break;
          case "parsing-complete":
            if (message.success) {
              handleParsingComplete(message.results);
            } else {
              displayError(message.message || "Failed to parse CSS");
            }
            break;
          case "creation-complete":
            if (message.success) {
              handleCreationComplete(message.results);
            } else {
              displayError(message.message || "Failed to create variables");
            }
            break;
          default:
            console.log("Unknown message type:", message.type);
        }
      }

      function handleCollectionsLoaded(data) {
        console.log("Received collections data:", data);

        availableLibraries = data.libraries || [];
        localCollections = data.localCollections || [];

        // Show warning if there were library errors
        if (data.libraryError) {
          console.warn("Library loading error:", data.libraryError);
          elements.libraryWarning.classList.remove("hidden");
        }

        // Update library info display
        var libraryList = document.getElementById("library-list");
        libraryList.innerHTML = "";

        if (availableLibraries.length === 0) {
          libraryList.innerHTML =
            '<div class="library-item">No libraries found</div>';
        } else {
          for (var i = 0; i < availableLibraries.length; i++) {
            var library = availableLibraries[i];
            var libraryHtml =
              '<div class="library-item">' +
              '<div class="library-name">' +
              library.libraryName +
              "</div>" +
              '<div class="collection-item">' +
              library.name +
              " (" +
              library.variableCount +
              " vars)";

            if (library.error) {
              libraryHtml +=
                ' <span class="error-text">(' + library.error + ")</span>";
            }

            libraryHtml += "</div></div>";
            libraryList.innerHTML += libraryHtml;
          }
        }

        // Populate library select dropdown
        elements.librarySelect.innerHTML =
          '<option value="">Choose a library collection...</option>';
        for (var i = 0; i < availableLibraries.length; i++) {
          var library = availableLibraries[i];
          var option = document.createElement("option");
          option.value = library.id;
          option.textContent =
            library.libraryName +
            " / " +
            library.name +
            " (" +
            library.variableCount +
            " vars)";
          elements.librarySelect.appendChild(option);
        }

        // Populate existing collection select
        elements.existingCollectionSelect.innerHTML =
          '<option value="">Choose an existing collection...</option>';
        for (var i = 0; i < localCollections.length; i++) {
          var collection = localCollections[i];
          var option = document.createElement("option");
          option.value = collection.id;
          option.textContent =
            collection.name + " (" + collection.modeCount + " modes)";
          elements.existingCollectionSelect.appendChild(option);
        }

        validateForm();
      }

      function handleParsingComplete(results) {
        isProcessing = false;
        currentResults = results;

        if (!results || !results.variables || results.variables.length === 0) {
          displayError("No @theme variables found in the CSS file.");
          return;
        }

        // Update preview
        elements.previewTotal.textContent = results.totalFound;
        elements.previewCount.textContent = results.variables.length;

        // Populate preview list
        populateResultList(
          elements.previewVariablesList,
          results.variables,
          false
        );

        showSection("preview-section");
      }

      function handleCreationComplete(results) {
        isProcessing = false;

        // Update summary counts
        elements.createdCount.textContent = results.summary.created;
        elements.updatedCount.textContent = results.summary.updated;
        elements.failedCount.textContent = results.summary.failed;

        elements.createdResultCount.textContent = results.created.length;
        elements.updatedResultCount.textContent = results.updated.length;
        elements.failedResultCount.textContent = results.failed.length;

        // Populate result lists
        populateResultList(elements.resultsCreatedList, results.created, false);
        populateResultList(elements.resultsUpdatedList, results.updated, false);
        populateResultList(elements.resultsFailedList, results.failed, true);

        showSection("results-section");
      }

      function populateResultList(listElement, items, showErrors) {
        listElement.innerHTML = "";

        if (items.length === 0) {
          listElement.innerHTML = '<div class="variable-item">No items</div>';
          return;
        }

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var div = document.createElement("div");
          div.className = "variable-item";

          var nameDiv = document.createElement("div");
          nameDiv.className = "variable-name";
          nameDiv.textContent = item.variableName;

          var referencesDiv = document.createElement("div");
          referencesDiv.className = "variable-references";

          if (showErrors && item.error) {
            var errorDiv = document.createElement("div");
            errorDiv.className = "error-text";
            errorDiv.textContent = item.error;
            referencesDiv.appendChild(errorDiv);
          } else {
            var lightRef = document.createElement("div");
            lightRef.className = "reference-item";
            lightRef.innerHTML =
              '<div class="reference-label">Light:</div>' +
              '<div class="reference-value">' +
              (item.lightReference || item.lightLibraryVar || "N/A") +
              "</div>";

            var darkRef = document.createElement("div");
            darkRef.className = "reference-item";
            darkRef.innerHTML =
              '<div class="reference-label">Dark:</div>' +
              '<div class="reference-value">' +
              (item.darkReference || item.darkLibraryVar || "N/A") +
              "</div>";

            referencesDiv.appendChild(lightRef);
            referencesDiv.appendChild(darkRef);
          }

          div.appendChild(nameDiv);
          div.appendChild(referencesDiv);
          listElement.appendChild(div);
        }
      }

      function showSection(sectionId) {
        var sections = [
          "upload-section",
          "loading-section",
          "preview-section",
          "results-section",
          "error-section",
        ];

        for (var i = 0; i < sections.length; i++) {
          var section = document.getElementById(sections[i]);
          if (section) {
            section.classList.add("hidden");
          }
        }

        var targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.remove("hidden");
        }
      }

      function displayError(message) {
        console.error("Displaying error:", message);
        elements.errorMessage.textContent = message;
        isProcessing = false;
        showSection("error-section");
      }

      function processFile(file) {
        if (isProcessing) return;

        if (!file.name.endsWith(".css")) {
          displayError("Please upload a CSS file (.css extension required).");
          return;
        }

        isProcessing = true;
        showSection("loading-section");
        elements.loadingText.textContent = "Parsing CSS file...";

        var reader = new FileReader();
        reader.onload = function (e) {
          parent.postMessage(
            {
              pluginMessage: {
                type: "parse-css",
                cssContent: e.target.result,
              },
            },
            "*"
          );
        };

        reader.onerror = function () {
          console.error("File read error");
          displayError("Error reading file. Please try again.");
        };

        reader.readAsText(file);
      }

      function createVariables() {
        if (isProcessing || !currentResults || !currentResults.variables)
          return;

        var selectedLibrary = elements.librarySelect.value;
        var collectionChoice = elements.existingRadio.checked
          ? "existing"
          : "new";
        var existingCollectionId = elements.existingCollectionSelect.value;

        if (!selectedLibrary) {
          alert("Please select a library collection.");
          return;
        }

        if (collectionChoice === "existing" && !existingCollectionId) {
          alert(
            "Please select an existing collection or choose to create a new one."
          );
          return;
        }

        isProcessing = true;
        showSection("loading-section");
        elements.loadingText.textContent = "Creating variables...";

        parent.postMessage(
          {
            pluginMessage: {
              type: "create-variables",
              variablesToCreate: currentResults.variables,
              selectedLibraryId: selectedLibrary,
              collectionChoice: collectionChoice,
              existingCollectionId: existingCollectionId,
            },
          },
          "*"
        );
      }

      function resetToUpload() {
        isProcessing = false;
        currentResults = null;

        // Reset form
        elements.fileInput.value = "";
        elements.librarySelect.value = "";
        elements.existingCollectionSelect.value = "";
        elements.newCollectionInput.value = "Theme Variables";
        elements.existingRadio.checked = true;
        elements.newRadio.checked = false;

        // Reset visual states
        document.getElementById("existing-option").classList.add("selected");
        document.getElementById("new-option").classList.remove("selected");
        elements.existingCollectionSelect.style.display = "block";
        elements.newCollectionInput.style.display = "none";

        elements.applyBtn.disabled = true;
        elements.loadingText.textContent = "Parsing CSS file...";
        elements.libraryWarning.classList.add("hidden");

        showSection("upload-section");

        // Reload collections
        parent.postMessage(
          {
            pluginMessage: { type: "get-collections" },
          },
          "*"
        );
      }

      // Event listeners setup
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");

        // File input listener
        if (elements.fileInput) {
          elements.fileInput.addEventListener("change", handleFileSelect);
        }

        // Button listeners
        if (elements.browseBtn) {
          elements.browseBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            if (!isProcessing && elements.fileInput) {
              elements.fileInput.click();
            }
          });
        }

        if (elements.uploadArea) {
          elements.uploadArea.addEventListener("click", function (e) {
            if (
              e.target === elements.browseBtn ||
              (elements.browseBtn && elements.browseBtn.contains(e.target))
            ) {
              return;
            }
            if (!isProcessing && elements.fileInput) {
              elements.fileInput.click();
            }
          });
        }

        // Form listeners
        if (elements.librarySelect) {
          elements.librarySelect.addEventListener("change", validateForm);
        }

        if (elements.existingRadio) {
          elements.existingRadio.addEventListener(
            "change",
            handleCollectionTypeChange
          );
        }

        if (elements.newRadio) {
          elements.newRadio.addEventListener(
            "change",
            handleCollectionTypeChange
          );
        }

        if (elements.existingCollectionSelect) {
          elements.existingCollectionSelect.addEventListener(
            "change",
            validateForm
          );
        }

        if (elements.newCollectionInput) {
          elements.newCollectionInput.addEventListener("input", validateForm);
        }

        // Action button listeners
        if (elements.cancelBtn) {
          elements.cancelBtn.addEventListener("click", resetToUpload);
        }

        if (elements.uploadNewBtn) {
          elements.uploadNewBtn.addEventListener("click", resetToUpload);
        }

        if (elements.retryBtn) {
          elements.retryBtn.addEventListener("click", resetToUpload);
        }

        if (elements.applyBtn) {
          elements.applyBtn.addEventListener("click", createVariables);
        }

        if (elements.closeBtn) {
          elements.closeBtn.addEventListener("click", function () {
            parent.postMessage(
              {
                pluginMessage: { type: "close-plugin" },
              },
              "*"
            );
          });
        }

        // Radio option click handlers
        var existingOption = document.getElementById("existing-option");
        var newOption = document.getElementById("new-option");

        if (existingOption) {
          existingOption.addEventListener("click", function () {
            elements.existingRadio.checked = true;
            elements.newRadio.checked = false;
            handleCollectionTypeChange();
          });
        }

        if (newOption) {
          newOption.addEventListener("click", function () {
            elements.newRadio.checked = true;
            elements.existingRadio.checked = false;
            handleCollectionTypeChange();
          });
        }

        // Add accordion functionality to result groups
        var resultGroups = document.getElementsByClassName("result-group");
        for (var i = 0; i < resultGroups.length; i++) {
          var group = resultGroups[i];
          var title = group.querySelector(".result-title");
          if (title) {
            title.addEventListener("click", function () {
              var parentGroup = this.parentNode;
              parentGroup.classList.toggle("collapsed");
            });
            // Start collapsed
            group.classList.add("collapsed");
          }
        }

        // Message handler
        window.onmessage = handleMessage;

        // Initialize collection type display
        handleCollectionTypeChange();

        console.log("Event listeners attached");
      });

      console.log("Script loaded");
    </script>
  </body>
</html>
