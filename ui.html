<!-- 
  Note: This is a Figma plugin UI file. 
  ES6+ features are not supported in Figma plugins.
  Keep all JavaScript code ES5 compatible.
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Theme Variables Mapper</title>
    <style>
      /* Inline CSS - Required for Figma plugins */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --card-foreground: 222.2 84% 4.9%;
        --primary: 222.2 47.4% 11.2%;
        --primary-foreground: 210 40% 98%;
        --secondary: 210 40% 96%;
        --secondary-foreground: 222.2 47.4% 11.2%;
        --muted: 210 40% 96%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --accent: 210 40% 96%;
        --border: 214.3 31.8% 91.4%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 210 40% 98%;
        --radius: 8px;
        --success: 142.1 76.2% 36.3%;
        --warning: 47.9 95.8% 53.1%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 13px;
        line-height: 1.5;
        color: hsl(var(--foreground));
        background-color: hsl(var(--background));
        padding: 20px;
      }

      #app {
        max-width: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .section {
        opacity: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .hidden {
        display: none !important;
      }

      /* Header */
      .header {
        text-align: center;
        padding: 16px 0;
        background: hsl(var(--background));
        border-radius: var(--radius);
        margin-bottom: 8px;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
        letter-spacing: -0.025em;
        line-height: 1.2;
      }

      .subtitle {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 500;
        max-width: 320px;
        margin: 0 auto;
        line-height: 1.4;
      }

      /* Upload area */
      .upload-area {
        border: 2px dashed hsl(var(--border));
        border-radius: calc(var(--radius) + 4px);
        padding: 48px 24px;
        text-align: center;
        background: hsl(var(--background));
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: hsl(var(--primary));
        background: hsl(var(--accent));
      }

      .upload-content .upload-icon {
        font-size: 56px;
        margin-bottom: 16px;
        opacity: 0.7;
      }

      .upload-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: hsl(var(--foreground));
        line-height: 1.3;
      }

      .upload-content p {
        color: hsl(var(--muted-foreground));
        margin-bottom: 24px;
        font-size: 14px;
        line-height: 1.4;
      }

      .supported-formats {
        text-align: center;
        margin-top: 16px;
      }

      .supported-formats small {
        color: hsl(var(--muted-foreground));
        font-size: 12px;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px 24px;
        background: hsl(var(--card));
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .loader {
        width: 28px;
        height: 28px;
        border: 3px solid hsl(var(--muted));
        border-top: 3px solid hsl(var(--primary));
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
      }

      /* Library Info */
      .library-info {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 16px;
        margin-bottom: 16px;
      }

      .library-info h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: hsl(var(--foreground));
      }

      .library-item {
        margin-bottom: 8px;
        padding: 8px;
        background: hsl(var(--muted) / 0.3);
        border-radius: calc(var(--radius) - 2px);
      }

      .library-name {
        font-weight: 600;
        font-size: 13px;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
      }

      .collection-item {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        margin-left: 12px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      }
      .collection-selector {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
      }

      .collection-selector h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: hsl(var(--foreground));
      }

      .collection-option {
        margin-bottom: 12px;
      }

      .collection-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: hsl(var(--foreground));
        cursor: pointer;
      }

      .collection-option input[type="radio"] {
        margin: 0;
      }

      .collection-option select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        margin-top: 8px;
      }

      .collection-option select:disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .library-selector {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
      }

      .library-selector h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: hsl(var(--foreground));
      }

      .library-selector select {
        width: 100%;
        padding: 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        border-radius: var(--radius);
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
        padding: 0 20px;
        height: 44px;
        gap: 8px;
      }

      .btn:disabled {
        pointer-events: none;
        opacity: 0.5;
      }

      .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border: 1px solid hsl(var(--primary));
      }

      .btn-primary:hover:not(:disabled) {
        background: hsl(var(--primary) / 0.9);
      }

      .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        border: 1px solid hsl(var(--border));
      }

      .btn-secondary:hover:not(:disabled) {
        background: hsl(var(--muted));
      }

      /* Cards */
      .summary-card,
      .result-group,
      .error-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .summary-card {
        padding: 24px;
        text-align: center;
      }

      .summary-card.success {
        border-color: hsl(var(--success) / 0.3);
        background: hsl(var(--success) / 0.05);
      }

      .summary-card.warning {
        border-color: hsl(var(--warning) / 0.3);
        background: hsl(var(--warning) / 0.05);
      }

      .summary-card.error {
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .stat-number {
        font-size: 32px;
        font-weight: 800;
        color: hsl(var(--primary));
        line-height: 1;
      }

      .summary-card.success .stat-number {
        color: hsl(var(--success));
      }

      .summary-card.warning .stat-number {
        color: hsl(var(--warning));
      }

      .summary-card.error .stat-number {
        color: hsl(var(--destructive));
      }

      .stat-label {
        color: hsl(var(--muted-foreground));
        font-size: 14px;
        font-weight: 600;
      }

      /* Result groups */
      .result-group {
        margin-bottom: 8px;
        overflow: visible;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
      }

      .result-title {
        padding: 12px 16px;
        background: hsl(var(--muted));
        border-bottom: 1px solid hsl(var(--border));
        font-size: 13px;
        font-weight: 600;
        margin: 0;
        color: hsl(var(--foreground));
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 40px;
      }

      .result-title::after {
        content: "▼";
        font-size: 10px;
        position: absolute;
        right: 16px;
        transition: transform 0.2s ease;
      }

      .result-group.collapsed .result-title::after {
        transform: rotate(-90deg);
      }

      .result-group.collapsed .variable-list {
        display: none;
      }

      .result-count {
        font-size: 11px;
        color: hsl(var(--muted-foreground));
        background: hsl(var(--background));
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
      }

      .variable-list {
        padding: 0;
        max-height: none;
        overflow-y: visible;
        transition: all 0.2s ease;
      }

      .variable-item {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        border-bottom: 1px solid hsl(var(--border));
      }

      .variable-item:last-child {
        border-bottom: none;
      }

      .variable-item:hover {
        background: hsl(var(--muted) / 0.3);
      }

      .variable-name {
        font-weight: 700;
        color: hsl(var(--foreground));
        font-size: 13px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        line-height: 1.3;
        word-break: break-all;
      }

      .variable-references {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: hsl(var(--muted) / 0.3);
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
      }

      .reference-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 11px;
        font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
        word-break: break-all;
      }

      .reference-label {
        color: hsl(var(--muted-foreground));
        font-weight: 500;
      }

      .reference-value {
        color: hsl(var(--foreground));
        font-weight: 600;
      }

      .error-text {
        color: hsl(var(--destructive));
        font-weight: 500;
        font-size: 11px;
        line-height: 1.4;
        word-break: break-word;
      }

      /* Actions */
      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid hsl(var(--border));
      }

      /* Error card */
      .error-card {
        padding: 32px 24px;
        text-align: center;
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
      }

      .error-card h3 {
        color: hsl(var(--destructive));
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
        line-height: 1.3;
      }

      .error-card p {
        color: hsl(var(--destructive) / 0.8);
        margin-bottom: 24px;
        font-size: 14px;
        line-height: 1.4;
      }

      /* Responsive */
      @media (max-width: 480px) {
        body {
          padding: 16px;
        }

        .summary-grid {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }

      /* Form Elements */
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        transition: all 0.2s ease;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: hsl(var(--foreground));
        margin-bottom: 8px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      /* Collection Selection */
      .collection-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }

      .collection-card h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: hsl(var(--foreground));
      }

      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .radio-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        padding: 12px;
        border-radius: var(--radius);
        border: 1px solid transparent;
        transition: all 0.2s ease;
      }

      .radio-option:hover {
        background: hsl(var(--muted) / 0.5);
      }

      .radio-option.selected {
        background: hsl(var(--accent));
        border-color: hsl(var(--primary));
      }

      .radio-input {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid hsl(var(--border));
        border-radius: 50%;
        margin: 0;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .radio-input:checked {
        border-color: hsl(var(--primary));
      }

      .radio-input:checked::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 8px;
        height: 8px;
        background: hsl(var(--primary));
        border-radius: 50%;
      }

      .radio-content {
        flex: 1;
      }

      .radio-label {
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 4px;
        display: block;
      }

      .radio-description {
        font-size: 12px;
        color: hsl(var(--muted-foreground));
        line-height: 1.4;
      }

      .collection-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        margin-top: 8px;
      }

      .collection-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 13px;
        margin-top: 8px;
      }

      .collection-input:focus,
      .collection-select:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Theme Variables Mapper</h1>
        <p class="subtitle">
          Map CSS @theme variables to Figma variables <br />
          with shared library references
        </p>
      </div>

      <div id="upload-section" class="section">
        <div class="library-info" id="library-info">
          <h3>📚 Available Libraries</h3>
          <div id="library-list">Loading libraries...</div>
        </div>

        <div class="upload-area" id="upload-area">
          <div class="upload-content">
            <div class="upload-icon">📁</div>
            <h3>Upload CSS File</h3>
            <p>Drag & drop your CSS file with @theme variables</p>
            <input type="file" id="file-input" accept=".css" hidden />
            <button id="browse-btn" class="btn btn-primary">Choose File</button>
          </div>
        </div>
        <div class="supported-formats">
          <small>Supported: .css files with @theme and light/dark modes</small>
        </div>
      </div>

      <div id="loading-section" class="section hidden">
        <div class="loading">
          <div class="loader"></div>
          <p id="loading-text">Parsing CSS file...</p>
        </div>
      </div>

      <div id="preview-section" class="section hidden">
        <h2>📋 Configure & Preview</h2>

        <div class="collection-card">
          <h3>📁 Select Variable Collection</h3>
          <div class="radio-group">
            <label class="radio-option" id="existing-option">
              <input
                type="radio"
                name="collection-type"
                value="existing"
                class="radio-input"
                id="existing-radio"
                checked
              />
              <div class="radio-content">
                <span class="radio-label">Use Existing Collection</span>
                <p class="radio-description">
                  Add variables to an existing collection
                </p>
                <select class="collection-select" id="library-select">
                  <option value="">Choose one collection...</option>
                </select>
              </div>
            </label>

            <label class="radio-option" id="new-option">
              <input
                type="radio"
                name="collection-type"
                value="new"
                class="radio-input"
                id="new-radio"
              />
              <div class="radio-content">
                <span class="radio-label">Create New Collection</span>
                <p class="radio-description">
                  Create a new collection for these variables
                </p>
                <input
                  type="text"
                  class="collection-input hidden"
                  id="collection-input"
                  placeholder="New Collection Name"
                />
              </div>
            </label>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-stat">
            <span class="stat-number" id="preview-total">0</span>
            <span class="stat-label">theme variables found</span>
          </div>
        </div>

        <div id="preview-variables" class="result-group">
          <h3 class="result-title">🎨 Variables to Create</h3>
          <div id="preview-variables-list" class="variable-list"></div>
        </div>

        <div class="actions">
          <button id="apply-btn" class="btn btn-primary">Apply Changes</button>
          <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>

      <div id="results-section" class="section hidden">
        <h2>🎉 Results</h2>

        <div class="summary-grid">
          <div class="summary-card success">
            <div class="summary-stat">
              <span class="stat-number" id="created-count">0</span>
              <span class="stat-label">Created</span>
            </div>
          </div>
          <div class="summary-card warning">
            <div class="summary-stat">
              <span class="stat-number" id="updated-count">0</span>
              <span class="stat-label">Updated</span>
            </div>
          </div>
          <div class="summary-card error">
            <div class="summary-stat">
              <span class="stat-number" id="failed-count">0</span>
              <span class="stat-label">Failed</span>
            </div>
          </div>
        </div>

        <div id="results-created" class="result-group">
          <h3 class="result-title">✅ Created Variables</h3>
          <div id="results-created-list" class="variable-list"></div>
        </div>

        <div id="results-updated" class="result-group">
          <h3 class="result-title">⚠️ Updated Variables</h3>
          <div id="results-updated-list" class="variable-list"></div>
        </div>

        <div id="results-failed" class="result-group">
          <h3 class="result-title">❌ Failed Variables</h3>
          <div id="results-failed-list" class="variable-list"></div>
        </div>

        <div class="actions">
          <button id="upload-new-btn" class="btn btn-secondary">
            Upload New File
          </button>
          <button id="close-btn" class="btn btn-primary">Close</button>
        </div>
      </div>

      <div id="error-section" class="section hidden">
        <div class="error-card">
          <h3>⚠️ Error</h3>
          <p id="error-message">Something went wrong.</p>
          <button id="retry-btn" class="btn btn-primary">
            Upload New File
          </button>
        </div>
      </div>
    </div>

    <script>
      console.log("Plugin UI loaded");

      var isProcessing = false;
      var currentResults = null;
      var availableLibraries = [];
      var localCollections = [];

      var elements = {
        fileInput: document.getElementById("file-input"),
        browseBtn: document.getElementById("browse-btn"),
        uploadArea: document.getElementById("upload-area"),
        librarySelect: document.getElementById("library-select"),
        collectionRadios: document.querySelectorAll(
          'input[name="collection-choice"]'
        ),
        existingCollectionSelect: document.getElementById(
          "existing-collection-select"
        ),
        uploadNewBtn: document.getElementById("upload-new-btn"),
        closeBtn: document.getElementById("close-btn"),
        retryBtn: document.getElementById("retry-btn"),
        cancelBtn: document.getElementById("cancel-btn"),
        applyBtn: document.getElementById("apply-btn"),
        loadingText: document.getElementById("loading-text"),
      };

      function handleFileSelect(event) {
        var file = event.target.files[0];
        if (file) {
          processFile(file);
        }
      }

      function handleCollectionTypeChange(event) {
        var radioOptions = elements.collectionRadios;
        if (radioOptions) {
          for (var i = 0; i < radioOptions.length; i++) {
            var radio = radioOptions[i];
            radio.parentElement.classList.toggle("selected", radio.checked);
          }
        }

        var existingSelect = elements.existingCollectionSelect;
        if (existingSelect) {
          existingSelect.classList.toggle(
            "hidden",
            !elements.existingRadio.checked
          );
        }
        elements.newCollectionInput.classList.toggle(
          "hidden",
          elements.existingRadio.checked
        );
        validateCollectionSelection();
      }

      function validateCollectionSelection() {
        var selectedLibrary = elements.librarySelect.value;
        var collectionChoice = document.querySelector(
          'input[name="collection-type"]:checked'
        );
        var existingCollectionId = elements.existingCollectionSelect.value;
        var newCollectionName = elements.newCollectionInput.value.trim();

        var isValid = selectedLibrary && collectionChoice;
        if (isValid) {
          if (elements.existingRadio.checked) {
            isValid = existingCollectionId !== "";
          } else {
            isValid = newCollectionName !== "";
          }
        }

        elements.applyBtn.disabled = !isValid;
      }

      function handleMessage(event) {
        var message = event.data.pluginMessage;
        if (!message) return;

        switch (message.type) {
          case "libraries-loaded":
            handleLibrariesLoaded(message.libraries, message.locals);
            break;
          case "parsing-complete":
            handleParsingComplete(message.results);
            break;
          case "creation-complete":
            handleCreationComplete(message.results);
            break;
          case "error":
            showError(message.message);
            break;
        }
      }

      function handleLibrariesLoaded(libraries, locals) {
        availableLibraries = libraries || [];
        localCollections = locals || [];

        var libraryList = document.getElementById("library-list");
        libraryList.innerHTML = "";

        for (var i = 0; i < availableLibraries.length; i++) {
          var library = availableLibraries[i];
          var libraryHtml =
            '<div class="library-item">' +
            '<div class="library-name">' +
            library.name +
            "</div>";

          for (var j = 0; j < library.collections.length; j++) {
            var collection = library.collections[j];
            var errorText = collection.error
              ? '<span class="error-text">' + collection.error + "</span>"
              : "";
            libraryHtml +=
              '<div class="collection-item">' +
              collection.name +
              errorText +
              "</div>";
          }
          libraryHtml += "</div>";
          libraryList.innerHTML += libraryHtml;
        }

        var select = document.getElementById("library-select");
        select.innerHTML = "";

        for (var i = 0; i < availableLibraries.length; i++) {
          var library = availableLibraries[i];
          for (var j = 0; j < library.collections.length; j++) {
            var collection = library.collections[j];
            var option = document.createElement("option");
            option.value = collection.id;
            option.textContent = library.name + " / " + collection.name;
            select.appendChild(option);
          }
        }

        var select = document.getElementById("existing-collection-select");
        select.innerHTML = "";

        for (var i = 0; i < localCollections.length; i++) {
          var collection = localCollections[i];
          var option = document.createElement("option");
          option.value = collection.id;
          option.textContent = collection.name;
          select.appendChild(option);
        }

        validateCollectionSelection();
      }

      function showSection(sectionId) {
        var sections = [
          "upload-section",
          "loading-section",
          "preview-section",
          "results-section",
          "error-section",
        ];

        for (var i = 0; i < sections.length; i++) {
          var section = document.getElementById(sections[i]);
          section.classList.add("hidden");
        }

        var targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.remove("hidden");
        }
      }

      function populateList(listId, items) {
        var section = document.getElementById(sectionId);
        var list = document.getElementById(listId);
        list.innerHTML = "";

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var div = document.createElement("div");
          div.className = "variable-item";

          var nameDiv = document.createElement("div");
          nameDiv.className = "variable-name";
          nameDiv.textContent = item.name;

          var referencesDiv = document.createElement("div");
          referencesDiv.className = "variable-references";

          var lightRef = document.createElement("div");
          lightRef.className = "reference light";
          lightRef.textContent = item.lightValue;

          var darkRef = document.createElement("div");
          darkRef.className = "reference dark";
          darkRef.textContent = item.darkValue;

          referencesDiv.appendChild(lightRef);
          referencesDiv.appendChild(darkRef);
          div.appendChild(nameDiv);
          div.appendChild(referencesDiv);
          list.appendChild(div);
        }

        var title = section.querySelector(".result-title");
        var existingCount = title.querySelector(".result-count");
        if (existingCount) {
          existingCount.textContent = items.length;
        } else {
          var countSpan = document.createElement("span");
          countSpan.className = "result-count";
          countSpan.textContent = items.length;
          title.appendChild(countSpan);
        }
      }

      function showError(message) {
        var errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        document.getElementById("error-section").appendChild(errorDiv);
        showSection("error-section");
      }

      document.addEventListener("DOMContentLoaded", function () {
        // File input listener
        elements.fileInput?.addEventListener("change", handleFileSelect);

        // Button listeners
        elements.browseBtn?.addEventListener("click", function (e) {
          e.stopPropagation();
          if (!isProcessing) elements.fileInput?.click();
        });

        elements.uploadArea?.addEventListener("click", function (e) {
          if (
            e.target === elements.browseBtn ||
            elements.browseBtn?.contains(e.target)
          )
            return;
          if (!isProcessing) elements.fileInput?.click();
        });

        elements.librarySelect?.addEventListener(
          "change",
          handleCollectionTypeChange
        );

        // Collection choice listeners
        elements.collectionRadios?.forEach((radio) => {
          radio.addEventListener("change", handleCollectionTypeChange);
        });

        elements.existingCollectionSelect?.addEventListener(
          "change",
          handleCollectionTypeChange
        );

        elements.cancelBtn?.addEventListener("click", resetToUpload);
        elements.uploadNewBtn?.addEventListener("click", resetToUpload);
        elements.retryBtn?.addEventListener("click", resetToUpload);

        elements.applyBtn?.addEventListener("click", function () {
          const selectedLibrary = elements.librarySelect.value;
          const collectionChoice = document.querySelector(
            'input[name="collection-type"]:checked'
          )?.value;
          const existingCollectionId = elements.existingCollectionSelect.value;

          if (
            currentResults?.variables &&
            selectedLibrary &&
            collectionChoice
          ) {
            if (collectionChoice === "existing" && !existingCollectionId) {
              alert(
                "Please select an existing collection or choose to create a new one."
              );
              return;
            }
            createVariables(
              currentResults.variables,
              selectedLibrary,
              collectionChoice,
              existingCollectionId
            );
          }
        });

        elements.closeBtn?.addEventListener("click", function () {
          parent.postMessage({ pluginMessage: { type: "close-plugin" } }, "*");
        });

        // Message handler
        window.onmessage = handleMessage;

        // Add accordion functionality to all result groups
        var resultGroups = document.getElementsByClassName("result-group");
        for (var i = 0; i < resultGroups.length; i++) {
          var group = resultGroups[i];
          var title = group.querySelector(".result-title");
          if (title) {
            title.addEventListener("click", function () {
              var parentGroup = this.parentNode;
              parentGroup.classList.toggle("collapsed");
            });
            // Ensure all groups start collapsed
            group.classList.add("collapsed");
          }
        }

        // Collection selection behavior
        var radioOptions = document.querySelectorAll(".radio-option");
        var collectionSelect = document.querySelector(".collection-select");
        var collectionInput = document.querySelector(".collection-input");

        radioOptions.forEach(function (option) {
          option.addEventListener("click", function () {
            // Remove selected class from all options
            radioOptions.forEach(function (opt) {
              opt.classList.remove("selected");
            });
            // Add selected class to clicked option
            this.classList.add("selected");
            // Update radio input checked state
            var radio = this.querySelector(".radio-input");
            radio.checked = true;
            // Show/hide appropriate input
            if (radio.value === "existing") {
              collectionSelect.style.display = "block";
              collectionInput.style.display = "none";
            } else {
              collectionSelect.style.display = "none";
              collectionInput.style.display = "block";
            }
          });
        });

        // Initialize state
        collectionInput.style.display = "none";
      });

      function processFile(file) {
        if (isProcessing) return;
        isProcessing = true;

        if (!file.name.endsWith(".css")) {
          displayError("Please upload a CSS file (.css extension required).");
          showSection("error-section");
          isProcessing = false;
          return;
        }

        showSection("loading-section");

        const reader = new FileReader();
        reader.onload = function (e) {
          parent.postMessage(
            {
              pluginMessage: { type: "parse-css", cssContent: e.target.result },
            },
            "*"
          );
        };

        reader.onerror = function () {
          console.error("File read error");
          displayError("Error reading file. Please try again.");
          showSection("error-section");
          isProcessing = false;
        };

        reader.readAsText(file);
      }

      function loadCollections() {
        document.getElementById("loading-text").textContent =
          "Loading collections...";
        parent.postMessage({ pluginMessage: { type: "get-collections" } }, "*");
      }

      function createVariables(
        variables,
        selectedLibraryId,
        collectionChoice,
        existingCollectionId
      ) {
        if (isProcessing) return;
        isProcessing = true;

        document.getElementById("loading-text").textContent =
          "Creating variables...";
        showSection("loading-section");

        parent.postMessage(
          {
            pluginMessage: {
              type: "create-variables",
              variablesToCreate: variables,
              selectedLibraryId: selectedLibraryId,
              collectionChoice: collectionChoice,
              existingCollectionId: existingCollectionId,
            },
          },
          "*"
        );
      }

      function resetToUpload() {
        isProcessing = false;
        currentResults = null;
        availableLibraries = [];
        localCollections = [];
        document.getElementById("loading-text").textContent =
          "Parsing CSS file...";

        // Reset library select
        const librarySelect = document.getElementById("library-select");
        librarySelect.innerHTML =
          '<option value="">Choose a library...</option>';

        // Reset collection select
        const collectionSelect = document.getElementById(
          "existing-collection-select"
        );
        collectionSelect.innerHTML =
          '<option value="">Choose a collection...</option>';
        collectionSelect.disabled = true;

        // Reset radio buttons
        document.querySelector(
          'input[name="collection-type"][value="new"]'
        ).checked = true;

        showSection("upload-section");
        const fileInput = document.getElementById("file-input");
        if (fileInput) fileInput.value = "";
      }

      function displayPreview(results) {
        document.getElementById("preview-total").textContent =
          results.totalFound;

        populateList(
          "preview-variables",
          "preview-variables-list",
          results.variables
        );

        // Update apply button state
        const updateButton = () => {
          const librarySelect = document.getElementById("library-select");
          const collectionChoice = document.querySelector(
            'input[name="collection-type"]:checked'
          )?.value;
          const existingCollectionSelect = document.getElementById(
            "existing-collection-select"
          );

          let canApply = librarySelect.value && collectionChoice;
          if (collectionChoice === "existing") {
            canApply = canApply && existingCollectionSelect.value;
          }

          document.getElementById("apply-btn").disabled = !canApply;
        };

        updateButton();
      }

      function displayCreationResults(results) {
        document.getElementById("created-count").textContent =
          results.summary.created;
        document.getElementById("updated-count").textContent =
          results.summary.updated;
        document.getElementById("failed-count").textContent =
          results.summary.failed;

        populateList(
          "results-created",
          "results-created-list",
          results.created
        );
        populateList(
          "results-updated",
          "results-updated-list",
          results.updated
        );
        populateList("results-failed", "results-failed-list", results.failed);
      }
    </script>
  </body>
</html>
